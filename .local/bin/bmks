#!/bin/sh

# set prefered launcher
PREFERRED_LAUNCHER=dmenu
# set path where urls will be stored
URL_FILE_PATH=$HOME/.config/bmks/
# name of file urls will be stored in
URL_FILE_NAME=urls

show_usage() {
    while IFS= read -r LINE; do
        printf "%s\n" "$LINE" ;
    done <<EOF
	bmks: unix bookmark management that sucks less

Usage: bmks [OPTIONS...];
  OPTIONS:
    help                              Show this help message;
    add                               Add a new bookmark;
    del                               Remove a bookmark;
    ls                                Show all bookmarks;

EOF
}

BROWSER="brave"
LIST_LIMIT=20

bmks_add() {
	[ -z "$url" ] && printf "Error: url must be provided\n\n" && show_usage && exit 0
	printf "Description: "
	read description
	[ -z "$description" ] && echo "$url" >> $URL_FILE_PATH/$URL_FILE_NAME
	[ -n "$description" ] && echo "$description - $url" >> $URL_FILE_PATH/$URL_FILE_NAME
}

bmks_ls() {
	bmks_check
	cat $URL_FILE_PATH/$URL_FILE_NAME | sort
}

bmks_del() {
	bmks_check
	case $PREFERRED_LAUNCHER in
		dmenu) sed -i "/$(cat $URL_FILE_PATH/$URL_FILE_NAME | sort | dmenu -l $(cat $URL_FILE_PATH/$URL_FILE_NAME | wc -l))/d" $URL_FILE_PATH/$URL_FILE_NAME ;;
		fzf) sed -i "/$(cat $URL_FILE_PATH/$URL_FILE_NAME | sort | fzf)/d" $URL_FILE_PATH/$URL_FILE_NAME ;;
	esac
}

# bmks_display() {
# 	bmks_check
# 	case $PREFERRED_LAUNCHER in
# 		dmenu) cat $URL_FILE_PATH/$URL_FILE_NAME | sort | dmenu -l $(cat $URL_FILE_PATH/$URL_FILE_NAME | wc -l) | awk '{print $(NF)}' | xargs -I '{}' $BROWSER {} ;;
# 		fzf) cat $URL_FILE_PATH/$URL_FILE_NAME | sort | fzf | awk '{print $(NF)}' | xargs -I '{}' $BROWSER {} ;;
# 	esac
# }

bmks_display() {
    bmks_check
    cat $URL_FILE_PATH/$URL_FILE_NAME | sort | dmenu -l $LIST_LIMIT | awk '{print $(NF)}' | xargs -I '{}' $BROWSER {}
}

bmks_check() {
	[ ! -s $URL_FILE_PATH/$URL_FILE_NAME ] && printf "Error: No bookmarks found to display. Try adding some!\n\n" && show_usage && exit 0
}

[ ! -d $URL_FILE_PATH ] && mkdir $URL_FILE_PATH
[ ! -f $URL_FILE_PATH/$URL_FILE_NAME ] && touch $URL_FILE_PATH/$URL_FILE_NAME

case "$1" in
	"help") show_usage ;;
	"add") url=$2; bmks_add ;;
	"del") bmks_del ;;
	"ls") bmks_ls ;;
	"dmenu") PREFERRED_LAUNCHER=$1; bmks_display ;;
	"fzf") PREFERRED_LAUNCHER=$1; bmks_display ;;
	*) bmks_display ;;
esac
